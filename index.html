<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã‚¹ãƒãƒ›æ—¥å ± - Smart Log Ultimate</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
    /* åŸºæœ¬è¨­å®š */
    body {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        background-color: #f3f4f6;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    /* æ•°å­—å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ */
    .digit-box {
        width: 13%;
        aspect-ratio: 1;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        font-weight: bold;
        background: white;
        color: #1f2937;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    .digit-box.active {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        background-color: #eff6ff;
    }

    /* ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .btn-press:active:not(:disabled) { transform: scale(0.97); }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
    ::-webkit-scrollbar { display: none; }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    
    /* ã‚³ãƒ”ãƒ¼å®Œäº†ã®ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
    .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
</style>

<div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col relative overflow-hidden">

    <header class="bg-blue-600 text-white p-5 shadow-md z-10 sticky top-0 flex-shrink-0 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <i class="fa-solid fa-truck-fast"></i> é…é€æ—¥å ± Pro
        </h1>
        <button v-if="viewingHistoryMode" @click="closeHistoryView" class="text-xs bg-blue-700 hover:bg-blue-800 px-3 py-1.5 rounded-full border border-blue-400 transition-colors">
            <i class="fa-solid fa-times mr-1"></i>é–‰ã˜ã‚‹
        </button>
    </header>

    <main class="flex-1 p-5 flex flex-col overflow-y-auto overflow-x-hidden rounded-t-3xl -mt-4 bg-gray-50 z-20 relative">
        
        <div v-if="screen === 'start'" class="flex flex-col gap-6 py-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 text-center animate-slide-in">
                <h2 class="text-xl font-bold mb-6 text-gray-800">æ¥­å‹™é–‹å§‹</h2>
                <p class="text-gray-500 mb-4 text-xs font-bold">å‡ºç™ºæ™‚ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼è·é›¢ã‚’å…¥åŠ›</p>
                
                <input ref="startInput" type="tel" pattern="[0-9]*" inputmode="numeric" v-model="inputBuffer" maxlength="7" class="opacity-0 absolute top-0 left-0 h-0 w-0" @blur="keepFocus">

                <div class="flex justify-between mb-2" @click="focusStartInput">
                    <div v-for="i in 7" :key="i" class="digit-box" :class="{ 'active': isActiveDigit(i, inputBuffer.length) }">
                        {{ getDisplayDigit(i, inputBuffer.length) }}
                    </div>
                </div>
                <div class="text-right text-gray-400 font-bold text-xs mb-8 px-2">km</div>

                <button @click="startWork" :disabled="inputBuffer.length === 0" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white font-bold py-4 rounded-2xl shadow-lg btn-press text-lg transition-all">
                    æ±ºå®šã—ã¦é–‹å§‹
                </button>
            </div>

            <div v-if="historyList.length > 0" class="animate-slide-in pb-10" style="animation-delay: 0.1s;">
                <div class="flex justify-between items-end mb-3 px-2">
                    <h3 class="text-sm font-bold text-gray-400">å®Œäº†ã—ãŸæ—¥å ±ï¼ˆå±¥æ­´ï¼‰</h3>
                    <button @click="clearAllHistory" class="text-xs text-red-500 font-bold hover:bg-red-50 px-2 py-1 rounded transition-colors">
                        <i class="fa-solid fa-trash-can mr-1"></i>å±¥æ­´ã‚’ä¸€æ‹¬å‰Šé™¤
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div v-for="(item, idx) in historyList" :key="idx" @click="viewHistory(item)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50 transition-colors cursor-pointer group relative overflow-hidden">
                        
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                                <i class="fa-solid fa-file-lines"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">{{ item.dateStr }}</div>
                                <div class="text-xs text-gray-400">èµ°è¡Œ: {{ item.totalDistance }} km / æ¡ˆä»¶: {{ item.logs.filter(l => l.type === 'arrival').length }}ä»¶</div>
                            </div>
                        </div>

                        <button @click.stop="deleteHistoryItem(idx)" class="w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all z-10 btn-press border border-red-100">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="screen === 'dashboard'" class="flex flex-col gap-5 h-full py-2">
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8" :class="lastAction === 'arrival' ? 'border-green-500' : 'border-blue-500'">
                <div class="text-xs font-bold text-gray-500 mb-1">ç¾åœ¨ã®çŠ¶æ…‹</div>
                <div class="text-xl font-bold text-gray-800 flex items-center gap-3">
                    <i v-if="lastAction === 'arrival'" class="fa-solid fa-box-open text-green-500"></i>
                    <i v-else class="fa-solid fa-truck text-blue-500"></i>
                    {{ lastAction === 'arrival' ? 'ä½œæ¥­ä¸­ï¼ˆåˆ°ç€æ¸ˆã¿ï¼‰' : 'ç§»å‹•ä¸­' }}
                </div>
            </div>

            <div class="flex-1 flex flex-col gap-4 justify-center my-2">
                <button @click="handleArrival" :disabled="lastAction === 'arrival'" class="flex-1 bg-green-500 disabled:bg-gray-200 disabled:text-gray-400 disabled:shadow-none text-white rounded-3xl shadow-md flex flex-col items-center justify-center gap-2 p-4 btn-press transition-all border-b-4 border-green-700 disabled:border-transparent">
                    <i class="fa-solid fa-location-dot text-4xl mb-1"></i>
                    <span class="text-2xl font-bold">åˆ°ç€</span>
                    <span class="text-xs opacity-90 font-bold" v-if="lastAction !== 'arrival'">ä½æ‰€ãƒ»æ™‚åˆ»ã‚’è¨˜éŒ²</span>
                    <span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full" v-else>åˆ°ç€æ¸ˆã¿</span>
                </button>
                <button @click="handleDeparture" :disabled="lastAction !== 'arrival'" class="flex-1 bg-orange-500 disabled:bg-gray-200 disabled:text-gray-400 disabled:shadow-none text-white rounded-3xl shadow-md flex flex-col items-center justify-center gap-2 p-4 btn-press transition-all border-b-4 border-orange-700 disabled:border-transparent">
                    <i class="fa-solid fa-play text-4xl mb-1 ml-2"></i>
                    <span class="text-2xl font-bold">å‡ºç™º</span>
                    <span class="text-xs opacity-90 font-bold" v-if="lastAction === 'arrival'">æ¬¡ã®ç›®çš„åœ°ã¸</span>
                    <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full" v-else>æœªåˆ°ç€</span>
                </button>
            </div>

            <button @click="goToSummary" class="mt-auto bg-gray-800 text-white font-bold py-4 rounded-2xl shadow-lg btn-press text-lg flex items-center justify-center gap-3">
                <i class="fa-solid fa-flag-checkered"></i> æ—¥å ±ç¢ºèª
            </button>
        </div>

        <div v-if="screen === 'mileage_check'" class="fixed inset-0 bg-gray-900/60 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl animate-slide-in">
                <h3 class="text-xl font-bold mb-2 text-gray-800">åˆ°ç€æ™‚ã®è·é›¢</h3>
                <p class="text-xs text-gray-500 mb-6 flex items-start gap-2 bg-gray-50 p-3 rounded-lg leading-relaxed">
                    <i class="fa-solid fa-map-pin text-red-500 mt-0.5 flex-shrink-0"></i>
                    {{ tempLocation }}
                </p>
                <input ref="modalInput" type="tel" pattern="[0-9]*" inputmode="numeric" v-model="inputBuffer" maxlength="7" class="opacity-0 absolute top-0 left-0 h-0 w-0" @blur="keepFocus">
                <div class="flex justify-between mb-2" @click="focusModalInput">
                    <div v-for="i in 7" :key="i" class="digit-box" :class="{ 'active': isActiveDigit(i, inputBuffer.length) }">{{ getDisplayDigit(i, inputBuffer.length) }}</div>
                </div>
                <div class="text-right text-gray-400 font-bold text-xs mb-8 px-2">km</div>
                <button @click="confirmArrival" :disabled="inputBuffer.length === 0" class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-bold py-4 rounded-2xl shadow-lg btn-press text-xl">æ±ºå®š</button>
            </div>
        </div>

        <div v-if="loading" class="fixed inset-0 bg-gray-900/40 z-50 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white p-5 rounded-2xl shadow-xl flex items-center gap-3">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-600"></i>
                <span class="font-bold text-gray-700">{{ loadingText }}</span>
            </div>
        </div>

        <div v-if="screen === 'summary'" class="bg-white rounded-3xl shadow-sm p-2 flex flex-col h-full border border-gray-100 pb-32">
            <div class="sticky top-0 bg-white z-10 p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-blue-600"></i> 
                    {{ viewingHistoryMode ? historyData.dateStr : 'æœ¬æ—¥ã®æ—¥å ±' }}
                </h2>
                <button v-if="!viewingHistoryMode" @click="backToDashboard" class="text-sm text-gray-500 font-bold underline">æˆ»ã‚‹</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-2xl text-white shadow-lg">
                    <div class="flex justify-between items-end mb-4">
                        <div class="text-blue-100 text-xs font-bold">ç·èµ°è¡Œè·é›¢</div>
                        <div class="text-3xl font-bold">{{ calculateTotalDistance }} <span class="text-base font-normal">km</span></div>
                    </div>
                    <div class="flex gap-4 border-t border-blue-400/50 pt-3">
                        <div>
                            <div class="text-blue-200 text-xs">é–‹å§‹</div>
                            <div class="font-bold">{{ viewingHistoryMode ? historyData.startMileage : startMileage }} km</div>
                        </div>
                        <div class="text-blue-200 pt-3">âœ</div>
                        <div>
                            <div class="text-blue-200 text-xs">çµ‚äº†(æœ€çµ‚)</div>
                            <div class="font-bold">{{ getLastMileage }} km</div>
                        </div>
                    </div>
                </div>

                <div v-for="(group, index) in groupedLogs" :key="index" class="relative pl-6 pb-6 border-l-2 border-gray-100 last:border-0 last:pb-0">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-blue-100 border-2 border-blue-500"></div>
                    <div class="mb-2"><span class="text-xs font-bold text-gray-400 mr-2">æ¡ˆä»¶ #{{ index + 1 }}</span></div>

                    <div v-if="group.arrival" class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg text-gray-800">{{ group.arrival.time }} <span class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded ml-1">åˆ°ç€</span></span>
                            <span class="font-mono font-bold text-blue-600">{{ group.arrival.mileage }} km</span>
                        </div>
                        <div class="text-sm text-gray-600 leading-relaxed break-words bg-gray-50 p-2 rounded">{{ group.arrival.address }}</div>
                    </div>

                    <div v-if="group.departure" class="flex items-center gap-2 mt-2 ml-2">
                        <i class="fa-solid fa-arrow-down text-gray-300"></i>
                        <span class="font-bold text-gray-700">{{ group.departure.time }}</span>
                        <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded">å‡ºç™º</span>
                    </div>
                </div>
            </div>

            <div class="fixed bottom-5 left-5 right-5 z-30 flex flex-col gap-3">
                
                <button @click="copyToClipboard" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-2xl shadow-md btn-press flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-brands fa-line text-xl"></i>
                    {{ showCopyToast ? 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼' : 'ãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒ”ãƒ¼ï¼ˆLINEç”¨ï¼‰' }}
                </button>

                <button v-if="!viewingHistoryMode" @click="saveAndReset" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3.5 rounded-2xl shadow-xl btn-press flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-check-double"></i> æ¥­å‹™å®Œäº†ã—ã¦ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹
                </button>
            </div>
        </div>

        <transition name="toast">
            <div v-if="showCopyToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 text-sm font-bold flex items-center gap-2">
                <i class="fa-solid fa-check text-green-400"></i> ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ
            </div>
        </transition>

    </main>
</div>

<script>
    const { createApp, ref, onMounted, nextTick, computed } = Vue;

    createApp({
        setup() {
            // State
            const screen = ref('start'); 
            const inputBuffer = ref('');
            const loading = ref(false);
            const loadingText = ref('');
            const lastAction = ref('none'); 
            const startMileage = ref(0);
            const logs = ref([]);
            
            // History
            const historyList = ref([]);
            const viewingHistoryMode = ref(false);
            const historyData = ref(null);
            
            // UI
            const showCopyToast = ref(false);
            const tempAddress = ref('');
            const tempTime = ref('');
            const startInput = ref(null);
            const modalInput = ref(null);

            // Init
            onMounted(() => {
                const savedData = localStorage.getItem('nippoData_pro_v2');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    screen.value = parsed.screen;
                    startMileage.value = parsed.startMileage;
                    logs.value = parsed.logs;
                    lastAction.value = parsed.lastAction;
                }
                const savedHistory = localStorage.getItem('nippoHistory_v2');
                if (savedHistory) historyList.value = JSON.parse(savedHistory);
            });

            const saveData = () => {
                const data = { screen: screen.value, startMileage: startMileage.value, logs: logs.value, lastAction: lastAction.value };
                localStorage.setItem('nippoData_pro_v2', JSON.stringify(data));
            };

            const updateHistoryStorage = () => {
                localStorage.setItem('nippoHistory_v2', JSON.stringify(historyList.value));
            };

            // Input Logic
            const getDisplayDigit = (idx, len) => idx <= 7 - len ? '' : inputBuffer.value[idx - (7 - len) - 1] || '';
            const isActiveDigit = (idx, len) => len < 7 && idx === 7;

            // Core Actions
            const focusStartInput = () => nextTick(() => startInput.value && startInput.value.focus());
            const focusModalInput = () => nextTick(() => modalInput.value && modalInput.value.focus());
            
            const startWork = () => {
                startMileage.value = inputBuffer.value;
                logs.value = [];
                inputBuffer.value = '';
                lastAction.value = 'start';
                screen.value = 'dashboard';
                saveData();
            };

            const handleArrival = async () => {
                loading.value = true;
                loadingText.value = 'ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...';
                const [time, address] = await Promise.all([
                    new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                    getCurrentLocation()
                ]);
                tempTime.value = time;
                tempAddress.value = address;
                loading.value = false;
                screen.value = 'mileage_check';
                inputBuffer.value = '';
                focusModalInput();
            };

            const confirmArrival = () => {
                logs.value.push({ type: 'arrival', time: tempTime.value, address: tempAddress.value, mileage: inputBuffer.value });
                lastAction.value = 'arrival';
                screen.value = 'dashboard';
                inputBuffer.value = '';
                saveData();
            };

            const handleDeparture = () => {
                logs.value.push({ type: 'departure', time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) });
                lastAction.value = 'departure';
                saveData();
            };

            // Location
            const getCurrentLocation = () => {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) { resolve('ä½ç½®æƒ…å ±éå¯¾å¿œ'); return; }
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        try {
                            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&zoom=18&addressdetails=1`, {headers: {'Accept-Language': 'ja'}});
                            const data = await res.json();
                            const a = data.address;
                            const formatted = [...new Set([a.province, a.city, a.ward, a.town, a.suburb, a.village, a.neighbourhood, a.road, a.house_number].filter(Boolean))].join('');
                            resolve(formatted || 'ä½æ‰€ä¸æ˜');
                        } catch { resolve('ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼'); }
                    }, () => resolve('ä½ç½®æƒ…å ±å–å¾—å¤±æ•—'), { enableHighAccuracy: true });
                });
            };

            // Summary & History
            const goToSummary = () => { screen.value = 'summary'; saveData(); };
            const backToDashboard = () => { screen.value = 'dashboard'; saveData(); };

            const saveAndReset = () => {
                if(!confirm('æœ¬æ—¥ã®æ¥­å‹™ã‚’å®Œäº†ã—ã€å±¥æ­´ã«ä¿å­˜ã—ã¦ãƒˆãƒƒãƒ—ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) return;
                const todayStr = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' });
                historyList.value.unshift({
                    dateStr: todayStr,
                    startMileage: startMileage.value,
                    logs: logs.value,
                    totalDistance: calculateTotalDistance.value
                });
                updateHistoryStorage();
                localStorage.removeItem('nippoData_pro_v2');
                screen.value = 'start';
                startMileage.value = 0;
                logs.value = [];
                lastAction.value = 'none';
                inputBuffer.value = '';
            };

            // New: Delete Features
            const deleteHistoryItem = (index) => {
                if(!confirm('æœ¬å½“ã«ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) return;
                historyList.value.splice(index, 1);
                updateHistoryStorage();
            };

            const clearAllHistory = () => {
                if(!confirm('ã€è­¦å‘Šã€‘\nå…¨ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã‚Œã¾ã§ã®è¨˜éŒ²ãŒå…¨ã¦æ¶ˆãˆã¾ã™ã€‚')) return;
                historyList.value = [];
                updateHistoryStorage();
            };

            // New: Copy Feature
            const copyToClipboard = () => {
                const targetLogs = viewingHistoryMode.value ? historyData.value.logs : logs.value;
                const targetStart = viewingHistoryMode.value ? historyData.value.startMileage : startMileage.value;
                const targetTotal = calculateTotalDistance.value;
                const dateTitle = viewingHistoryMode.value ? historyData.value.dateStr : new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' });
                
                // LINEå‘ã‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆ
                let text = `ğŸ“… æ—¥å ±å ±å‘Š ${dateTitle}\n`;
                text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                text += `ğŸšš ç·èµ°è¡Œè·é›¢: ${targetTotal} km\n`;
                text += `(é–‹å§‹: ${targetStart}km â” çµ‚äº†: ${getLastMileage.value}km)\n`;
                text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;

                let caseCount = 1;
                let currentGroup = [];
                
                // ãƒ­ã‚°ã®æ•´å½¢
                targetLogs.forEach(log => {
                    if(log.type === 'arrival') {
                        text += `ã€æ¡ˆä»¶ ${caseCount}ã€‘\n`;
                        text += `ğŸ“ åˆ°ç€: ${log.time} (${log.mileage}km)\n`;
                        text += `   ${log.address}\n`;
                        caseCount++;
                    } else if(log.type === 'departure') {
                        text += `â–¶ï¸ å‡ºç™º: ${log.time}\n\n`;
                    }
                });

                text += `\nä»¥ä¸Šã€å ±å‘Šè‡´ã—ã¾ã™ã€‚`;

                navigator.clipboard.writeText(text).then(() => {
                    showCopyToast.value = true;
                    setTimeout(() => showCopyToast.value = false, 2000);
                });
            };

            const viewHistory = (item) => {
                viewingHistoryMode.value = true;
                historyData.value = item;
                screen.value = 'summary';
            };
            const closeHistoryView = () => {
                viewingHistoryMode.value = false;
                historyData.value = null;
                screen.value = 'start';
            };

            // Computed
            const activeLogs = computed(() => viewingHistoryMode.value ? historyData.value?.logs || [] : logs.value);
            const activeStart = computed(() => viewingHistoryMode.value ? historyData.value?.startMileage || 0 : startMileage.value);
            
            const getLastMileage = computed(() => {
                const arr = activeLogs.value.filter(l => l.type === 'arrival' && l.mileage);
                return arr.length ? arr[arr.length - 1].mileage : '---';
            });

            const calculateTotalDistance = computed(() => {
                const last = getLastMileage.value;
                if (last === '---') return 0;
                return parseInt(last) - parseInt(activeStart.value);
            });

            const groupedLogs = computed(() => {
                const groups = [];
                let currentGroup = null;
                activeLogs.value.forEach(log => {
                    if (log.type === 'arrival') {
                        currentGroup = { arrival: log, departure: null };
                        groups.push(currentGroup);
                    } else if (log.type === 'departure') {
                        if (currentGroup) currentGroup.departure = log;
                        else groups.push({ arrival: null, departure: log });
                        currentGroup = null;
                    }
                });
                return groups;
            });

            return {
                screen, inputBuffer, loading, loadingText, lastAction, startMileage,
                historyList, viewingHistoryMode, historyData, showCopyToast,
                startInput, modalInput, tempLocation: tempAddress,
                getDisplayDigit, isActiveDigit, focusStartInput, focusModalInput, keepFocus: () => {},
                startWork, handleArrival, confirmArrival, handleDeparture,
                goToSummary, backToDashboard, saveAndReset, viewHistory, closeHistoryView,
                groupedLogs, calculateTotalDistance, getLastMileage,
                deleteHistoryItem, clearAllHistory, copyToClipboard
            };
        }
    }).mount('#app');
</script>